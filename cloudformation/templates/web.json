{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Web Stack",

  "Metadata" : {
  },

  "Parameters" : {
    "Target" : {
      "Type" : "String"
    },
    "Stack" : {
      "Type" : "String"
    },
    "NetworkingStackName" : {
      "Type" : "String"
    },
    "WebServerCount" : {
      "Type" : "String"
    },
    "WebServerInstanceType" : {
      "Type" : "String"
    },
    "WebServerAMI" : {
      "Type" : "String"
    },
    "KeyName" : {
      "Type" : "String"
    }
  },

  "Mappings" : {
  },

  "Conditions" : {
  },

  "Resources" : {
    "IAMRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "RoleName" : "slalom_web_server",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [
            {
              "Action" : "sts:AssumeRole",
              "Principal" : {
                "Service" : "ec2.amazonaws.com"
              },
              "Effect" : "Allow",
              "Sid" : ""
            }
          ]
        }
      }
    },

    "IAMPolicy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "slalom_web_server_policy",
        "Roles" : [{ "Ref" : "IAMRole" }],
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [
            {
              "Action" : [
                "s3:*"
              ],
              "Effect" : "Allow",
              "Resource" : "*"
            }
          ]
        }
      }
    },

    "IAMProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Roles" : [{ "Ref" : "IAMRole" }]
      }
    },

    "WebSG" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Security group for web servers",
        "SecurityGroupIngress" : [
          {
            "IpProtocol" : "tcp",
            "FromPort" : "22",
            "ToPort" : "22",
            "CidrIp" : "0.0.0.0/0"
          },
          {
            "IpProtocol" : "tcp",
            "FromPort" : "80",
            "ToPort" : "80",
            "CidrIp" : "0.0.0.0/0"
          }
        ],
        "SecurityGroupEgress" : [
          {
            "IpProtocol" : "-1",
            "FromPort" : "0",
            "ToPort" : "0",
            "CidrIp" : "0.0.0.0/0"
          }
        ],
        "VpcId" : { "Fn::ImportValue" : {"Fn::Sub": "${NetworkingStackName}-VPCID"} },
        "Tags" : [ { "Key" : "Name", "Value" : "slalom_aws_intro_webserver" } ]
      }
    },

    "ELB" : {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "LoadBalancerName" : "slalom-aws-intro-web-elb",
        "CrossZone" : "true",
        "Subnets" : [{ "Fn::ImportValue" : {"Fn::Sub": "${NetworkingStackName}-PubSubnet1"} },{ "Fn::ImportValue" : {"Fn::Sub": "${NetworkingStackName}-PubSubnet2"} }],
        "SecurityGroups" : [{ "Ref" : "WebSG" }],
        "ConnectionDrainingPolicy" : { "Enabled" : "true" , "Timeout" : 300 },
        "Listeners" : [{
            "InstancePort" : "80",
            "InstanceProtocol" : "http",
            "LoadBalancerPort" : "80",
            "Protocol" : "http"
          }],
        "Tags" : [ { "Key" : "Name", "Value" : "slalom_aws_intro_web_elb" } ]
      }
    },

    "LaunchConfig" : {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Properties" : {
        "AssociatePublicIpAddress" : "true",
        "ImageId" : { "Ref" : "WebServerAMI" },
        "InstanceType" : { "Ref" : "WebServerInstanceType" },
        "IamInstanceProfile" : { "Ref" : "IAMProfile" },
        "KeyName" : { "Ref" : "KeyName" },
        "SecurityGroups" : [{ "Ref" : "WebSG" }],
        "UserData" : {
          "Fn::Base64" : {
            "Fn::Join" : [ "\n", [
            "#!/bin/bash",
            "sudo yum update -y",
            "sudo yum install httpd -y",
            "sudo service httpd start",
            "sudo chkconfig httpd on",
            "sudo groupadd www",
            "sudo usermod -a -G www ec2-user",
            "sudo chown -R ec2-user:ec2-user /var/www",
            "sudo chmod 2775 /var/www",
            "aws s3 cp s3://slalom-aws-intro/index.html /var/www/html/index.html",
            "aws s3 cp s3://slalom-aws-intro/slalomlogo.png /var/www/html/slalomlogo.png",
            "sudo find /var/www -type d -exec chmod 2775 {} +",
            "sudo find /var/www -type f -exec chmod 664 {} +"
            ]]
          }
        }
      }
    },

    "AutoscaleGroup" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "MaxSize" : "2",
        "MinSize" : "2",
        "LaunchConfigurationName" : { "Ref" : "LaunchConfig" },
        "LoadBalancerNames" : [{ "Ref" : "ELB" }],
        "VPCZoneIdentifier" : [{ "Fn::ImportValue" : {"Fn::Sub": "${NetworkingStackName}-PubSubnet1"} },{ "Fn::ImportValue" : {"Fn::Sub": "${NetworkingStackName}-PubSubnet2"} }],
        "Tags" : [ { "Key" : "Name",
         "Value" : "slalom_aws_intro_web_asg", 
         "PropagateAtLaunch" : "true" } ]
      }
    }

  },

  "Outputs" : {
  }
}







